blueprint:
  name: FoxESS-Cloud-Octopus Inteligent Go - Zappi
  author: PowerLockr.co.uk
  source_url: https://cloud.thebowrings.co.uk/index.php/s/KRRNFqTa45L8HJj/download/Cloud-OctopusInteligentGo-Zappi-external.yaml
  description: > 
    # Overview
    
    When using Octopus Energy with an Zappi charger, this automation will prevent FoxESS battery discharge into the car while
    charging.
    Octopus provide intelligent charging windows during the day, this blueprint will charge the FoxESS battery during these
    windows to ensure that the car is charged using the cheapest electricity.
    Octopus also provide off peak electricity at night, this blueprint will also charge the battery during these times.

    # This is an testing version of this blueprint specifically for Zappi users.

  domain: automation
  homeassistant:
    min_version: 2025.8.3
  input:
    octopus_off_peak:
      name: Octopus Energy Off Peak Electricity Sensor
      description: Sensor that shows when off peak electricity is available, this is both over night or during the day when using intelligent dispatching.
      selector:
        entity:
          filter:
            domain: binary_sensor
            integration: octopus_energy      
    octopus_dispatching:
      name: Octopus Intelligent Dispatching Sensor
      selector:
        entity:
          filter:
            integration: octopus_energy
            domain: binary_sensor
    foxess_cloud_work_mode:
      name: FoxESS Cloud Inverter Work Mode
      selector:
        entity:
          filter:
            domain: select
            integration: foxess_cloud
    foxess_cloud_scheduler_enable:
      name: FoxESS Cloud Inverter Scheduler Enabled
      description: Sensor that shows if the FoxESS Cloud scheduler is enabled
      selector:
        entity:
          filter:
            domain: binary_sensor
            integration: foxess_cloud
    foxess_cloud_inverter_serial:
      name: FoxESS Cloud Inverter Serial Number
      description: The serial number of the FoxESS inverter to control, needed for scheduling
      selector:
        text:
    foxess_cloud_charge_rate:
      name: FoxESS Cloud Inverter Charge Rate in Watts
      description: Enter the desired charge rate in Watts, i.e 3000 for 3kW
      default: 3000
      selector:
        number:
          min: 1000
          max: 10000
          step: 1000
          unit_of_measurement: W
    zappi_ev_power:
      name: Zappi EV Power
      description: Sensor to monitor the power being used by the Zappi EV charger, We are looking here for a sensor with "internal load ct1" as the name or alternatively just the sensor that shows the realtime power usage of the EV charger
      selector:
        entity:
          filter:
            domain: sensor
            integration: myenergi
    foxess_cloud_battery_discharge_power:
      name: FoxESS Cloud Battery Discharge Power (W)
      description: Sensor showing battery discharge power in Watts (positive number when discharging).
      selector:
        entity:
          filter:
            domain: sensor
            integration: foxess_cloud

    notification_device:
      name: Notification Device
      default: notify.notify
      description: The mobile_app device to send notifications to, i.e notify.mobile_app_my_iphone, unfortuently, its not possible to provide a workable dropdown, you must get the name, or use the default notify.notify to send to all devices in Home Assistant.
      selector:
        text:
    notification_event:
      name: Notification Event
      description: This sends a notification event to home-assistant which can used by other automations i.e blueprint-notification
      default: blueprint-notification
      selector:
        text:
    notification_enabled:
      name: Do you want to enable notifications?
      description: Enable or disable sending notifications
      default: true
      selector:
        boolean:
    optimistic_enabled:
      name: Do you want to enable optimistic charging
      description: The HA Octopus integration provides sensors for cheap and intelligent dispatching, but these sensors can sometimes lag behind or not update correctly at all. Enabling optimistic charging will ignore the Octopus sensors and follow the EV charger instead, this means that if you force charge your EV outside of a cheap period the house battery will also charge at this more expensive rate. For Zappi it is recommended to disable this option.
      default: false
      selector:
        boolean:
    automation_mode:
      name: Automation Mode
      description: Choose the automation behavior - "charge" to enable full charging automation, "protection" to only enable battery protection (prevents discharge while car charges, no active charging)
      default: charge
      selector:
        select:
          options:
            - charge
            - protection
variables:
  dispatch_entity: !input octopus_dispatching
  off_peak_entity: !input octopus_off_peak
  notification_enabled: !input notification_enabled
  optimistic_enabled: !input optimistic_enabled
  automation_mode: !input automation_mode
  fox_discharge_entity: !input foxess_cloud_battery_discharge_power
  fox_work_mode_entity: !input foxess_cloud_work_mode
  fox_scheduler_entity: !input foxess_cloud_scheduler_enable
triggers:
  # These are the Charging Triggers
  - trigger: state
    id: octopus_off_peak_on
    entity_id: !input octopus_off_peak
    from: "off"
    to: "on"
  - trigger: numeric_state
    id : zappi_ev_charging_above_1
    alias: Zappi EV charging (detected above 1kw)
    entity_id: !input zappi_ev_power
    above: 1
    # Time is needed because the car might be plugged in, not charging, but the cheap electricity is already on
    # This happens when the car has completed charging before 23:00 but octopus hasnt updated.
  - trigger: time
    id: Time 23:31:00
    at: "23:31:00"
  # This is needed to check if the car is still charging before night time cheap electricity starts
  # If it is then we need to enable the nightime schedule
  - trigger: time
    id: Time 23:29:00
    at: "23:29:00"
  # end of charging triggers

  # Start of stop charging triggers
  - trigger: time
    id: Time 05:29:55
    # This is needed because sometimes the car could be plugged in and not charging, but octopus may still have a cheap energy period active
    # do not want to risk using cheap electricity because the car wont charge, therefore octopus can take it away.
    at: "05:29:55"
    enabled: true
  - trigger: numeric_state
    id: EV Power 0
    entity_id: !input zappi_ev_power
    below: 1
    enabled: true
  # end of stop charging triggers

  # FoxESS Cloud health triggers

  - trigger: numeric_state
    id : foxess_cloud_battery_discharge_above_2
    alias: FoxESS Cloud Battery Discharge (detected above 2kw)
    entity_id: !input foxess_cloud_battery_discharge_power
    above: 2000

  - trigger: state
    id: foxess_discharge_sensor_bad
    entity_id: !input foxess_cloud_battery_discharge_power
    to:
      - "unavailable"
      - "unknown"

  - trigger: state
    id: foxess_work_mode_bad
    entity_id: !input foxess_cloud_work_mode
    to:
      - "unavailable"
      - "unknown"

  - trigger: state
    id: foxess_scheduler_enable_bad
    entity_id: !input foxess_cloud_scheduler_enable
    to:
      - "unavailable"
      - "unknown"

action:
  # Start Charging Actions
  # 1) Over night Options
  - alias: Start Charging Actions
    choose:
      - conditions:
          - condition: trigger
            id: 
              - octopus_off_peak_on
              - zappi_ev_charging_above_1
              - Time 23:31:00
          - condition: time
            after: "23:30:00"
            before: "05:30:00"
            weekday:
              - sun
              - sat
              - fri
              - thu
              - wed
              - tue
              - mon
          - condition: or
            conditions:
              - condition: state
                entity_id: !input octopus_off_peak
                state: "on"
              - condition: template
                value_template: "{{ optimistic_enabled }}"
          - condition: not
            conditions:
              - condition: state
                entity_id: !input foxess_cloud_scheduler_enable
                state: "on"
            alias: Not already in Force Charge Mode
          - condition: template
            value_template: "{{ automation_mode == 'charge' }}"
            alias: Automation mode is charge
        sequence:
          - action: select.select_option
            alias: Set Work Mode to Self Use
            data:
              option: SelfUse
            target:
              entity_id: !input foxess_cloud_work_mode
          - alias: Set Scheduler
            action: foxess_cloud.set_schedule
            data:
              device_sn: !input foxess_cloud_inverter_serial
              groups:
                #Night time to midnight charging 
                - enable: 1
                  startHour: 23
                  startMinute: 30
                  endHour: 23
                  endMinute: 59
                  workMode: ForceCharge
                  minSocOnGrid: 20
                  fdSoc: 100
                  fdPwr: !input foxess_cloud_charge_rate
                  maxSoc: 100
                # Midnight to early morning
                - enable: 1
                  startHour: 0
                  startMinute: 0
                  endHour: 5
                  endMinute: 29
                  workMode: ForceCharge
                  minSocOnGrid: 20
                  fdSoc: 100
                  fdPwr: !input foxess_cloud_charge_rate
                  maxSoc: 100
                # (Daytime) Early morning to night time
                - enable: 0
                  startHour: 5
                  startMinute: 30
                  endHour: 23
                  endMinute: 29
                  workMode: ForceCharge
                  minSocOnGrid: 20
                  fdSoc: 100
                  fdPwr: !input foxess_cloud_charge_rate
                  maxSoc: 100
          - alias: Notification
            choose:
              - alias: Notify if enabled
                conditions:                
                  - condition: template
                    alias: Are Notifications Enabled? 
                    value_template: >- 
                      {{ notification_enabled }}
                sequence:
                  - service: !input notification_device
                    data:
                      title: "Battery Charging"
                      message: "Started Charging"
          - event: !input notification_event
            event_data:
              title: Battery Charging
              message: "Started Charging"
        alias: START CHARGE - Overnight Off Peak
      # 2) Day time, battery protection here
      #    The charger will show current before the off peak sensor updates, this is to catch problems
      - conditions:
          - condition: trigger
            id: 
              - octopus_off_peak_on
              - zappi_ev_charging_above_1
              - Time 23:31:00
          - condition: time
            after: "05:30:00"
            before: "23:30:00"
            weekday:
              - sun
              - sat
              - fri
              - thu
              - wed
              - tue
              - mon
          - condition: or
            conditions:
              - condition: template
                value_template: "{{ automation_mode == 'protection' }}"
              - condition: and
                conditions:
                  - condition: state
                    entity_id: !input octopus_off_peak
                    state: "off"
                  - condition: template
                    value_template: "{{ not optimistic_enabled }}"
          - condition: numeric_state
            entity_id: !input zappi_ev_power
            above: 0
        sequence:
          - alias: Set Workmode to Backup
            action: select.select_option
            target:
              entity_id: !input foxess_cloud_work_mode
            data:
              option: Backup
          - alias: Notification
            choose:
              - alias: Notify if enabled
                conditions:                
                  - condition: template
                    alias: Are Notifications Enabled? 
                    value_template: >- 
                      {{ notification_enabled }}
                sequence:
                  - service: !input notification_device
                    data:
                      title: "Battery Charging"
                      message: "HOLD CHARGE: Daytime Battery Drain Protection, off peak is off, car is charging"
          - event: !input notification_event
            event_data:
              title: Battery Charging
              message: "HOLD CHARGE: Daytime Battery Drain Protection, off peak is off, car is charging"
        alias: HOLD CHARGE - Daytime Battery Drain Protection, off peak is off, car is charging
      # 3) Day time conditions here
      - conditions:
          - condition: trigger
            id: 
              - octopus_off_peak_on
              - zappi_ev_charging_above_1
              - Time 23:31:00
          - condition: time
            after: "05:30:00"
            before: "23:30:00"
            weekday:
              - sun
              - sat
              - fri
              - thu
              - wed
              - tue
              - mon
          - condition: or
            conditions:
              - condition: state
                entity_id: !input octopus_off_peak
                state: "on"
              - condition: template
                value_template: "{{ optimistic_enabled }}"
          - condition: numeric_state
            entity_id: !input zappi_ev_power
            above: 0
          - condition: not #Prevents execution when already charging due to multiple triggers
            conditions:
              - condition: state
                entity_id: !input foxess_cloud_scheduler_enable
                state: "on"
            alias: Not already in Force Charge Mode
          - condition: template
            value_template: "{{ automation_mode == 'charge' }}"
            alias: Automation mode is charge
        sequence:
          - action: select.select_option
            alias: Set Work Mode to Self Use
            data:
              option: SelfUse
            target:
              entity_id: !input foxess_cloud_work_mode
          - alias: Set Scheduler
            action: foxess_cloud.set_schedule
            data:
              device_sn: !input foxess_cloud_inverter_serial
              groups:
                #Night time to midnight charging 
                - enable: 0
                  startHour: 23
                  startMinute: 30
                  endHour: 23
                  endMinute: 59
                  workMode: ForceCharge
                  minSocOnGrid: 20
                  fdSoc: 100
                  fdPwr: !input foxess_cloud_charge_rate
                  maxSoc: 100
                # Midnight to early morning
                - enable: 0
                  startHour: 0
                  startMinute: 0
                  endHour: 5
                  endMinute: 29
                  workMode: ForceCharge
                  minSocOnGrid: 20
                  fdSoc: 100
                  fdPwr: !input foxess_cloud_charge_rate
                  maxSoc: 100
                # (Daytime) Early morning to night time
                - enable: 1
                  startHour: 5
                  startMinute: 30
                  endHour: 23
                  endMinute: 29
                  workMode: ForceCharge
                  minSocOnGrid: 20
                  fdSoc: 100
                  fdPwr: !input foxess_cloud_charge_rate
                  maxSoc: 100
          - alias: Notification
            choose:
              - alias: Notify if enabled
                conditions:                
                  - condition: template
                    alias: Are Notifications Enabled? 
                    value_template: >- 
                      {{ notification_enabled }}
                sequence:
                  - service: !input notification_device
                    data:
                      title: "Battery Charging"
                      message: "Daytime Charge, off peak on, car is charging, Battery Charging"
          - event: !input notification_event
            event_data:
              title: Battery Charging
              message: "Daytime Charge, off peak on, car is charging, Battery Charging"
        alias: START CHARGE - Daytime charge, off peak is on, car is charging
      # 4) Continue charging before night time off peak starts, We could just enable all schedules at the start, but this is just a cautious way to manage
      #    incase the cloud integration doesn't work as expected
      - conditions:
          - condition: trigger
            id: 
              - Time 23:29:00
          - condition: time
            after: "05:30:00"
            before: "23:30:00"
            weekday:
              - sun
              - sat
              - fri
              - thu
              - wed
              - tue
              - mon
          - condition: or
            conditions:
              - condition: state
                entity_id: !input octopus_off_peak
                state: "on"
              - condition: template
                value_template: "{{ optimistic_enabled }}"
          - condition: numeric_state
            entity_id: !input zappi_ev_power
            above: 0
          - condition: state
            entity_id: !input foxess_cloud_scheduler_enable
            state: "on"
          - condition: template
            value_template: "{{ automation_mode == 'charge' }}"
            alias: Automation mode is charge
        sequence:
          - alias: Change Scheduler
            action: foxess_cloud.set_schedule
            data:
              device_sn: !input foxess_cloud_inverter_serial
              groups:
                #Night time to midnight charging 
                - enable: 1
                  startHour: 23
                  startMinute: 30
                  endHour: 23
                  endMinute: 59
                  workMode: ForceCharge
                  minSocOnGrid: 20
                  fdSoc: 100
                  fdPwr: !input foxess_cloud_charge_rate
                  maxSoc: 100
                # Midnight to early morning
                - enable: 1
                  startHour: 0
                  startMinute: 0
                  endHour: 5
                  endMinute: 29
                  workMode: ForceCharge
                  minSocOnGrid: 20
                  fdSoc: 100
                  fdPwr: !input foxess_cloud_charge_rate
                  maxSoc: 100
                # (Daytime) Early morning to night time
                - enable: 1
                  startHour: 5
                  startMinute: 30
                  endHour: 23
                  endMinute: 29
                  workMode: ForceCharge
                  minSocOnGrid: 20
                  fdSoc: 100
                  fdPwr: !input foxess_cloud_charge_rate
                  maxSoc: 100
          - alias: Notification
            choose:
              - alias: Notify if enabled
                conditions:                
                  - condition: template
                    alias: Are Notifications Enabled? 
                    value_template: >- 
                      {{ notification_enabled }}
                sequence:
                  - service: !input notification_device
                    data:
                      title: "Battery Charging"
                      message: "Continue CHARGE - Car is still Charging lets enable night time schedule"
          - event: !input notification_event
            event_data:
              title: Battery Charging
              message: "Continue CHARGE - Car is still Charging lets enable night time schedule"
        alias: Continue CHARGE - Car is still Charging lets enable night time schedule
  # End Charging Actions

  # Stop Charging Actions
  - alias: Stop Charging Actions
    choose:
      - conditions:
      # This condition triggers usually only if the battery protection has kicked in but the charging never starts, this sometimes happens
      # for some reason, maybe its that octopus changes its mind
      # not tested but this condition will likely be good for a charge boost
          - condition: trigger
            id:
              - EV Power 0
          - condition: time
            after: "05:30:00"
            before: "23:30:00"
            weekday:
              - sun
              - sat
              - fri
              - wed
              - thu
              - tue
              - mon
          - condition: state
            alias: Inverter is in Backup mode
            entity_id: !input foxess_cloud_work_mode
            state:
              - Backup #This mode stops discharge, so battery protection is active
        sequence:
          - action: select.select_option
            alias: Set Work Mode to Self Use
            data:
              option: SelfUse
            target:
              entity_id: !input foxess_cloud_work_mode
          - alias: Notification
            choose:
              - alias: Notify if enabled
                conditions:                
                  - condition: template
                    alias: Are Notifications Enabled? 
                    value_template: >- 
                      {{ notification_enabled }}
                sequence:
                  - service: !input notification_device
                    data:
                      title: Battery Stop Charging
                      message: "Stopped Battery Protection"
          - event: !input notification_event
            event_data:
              title: Battery Stop Charging
              message: "Stopped Battery Protection"
        alias: Car Stops Charging, During Day, Inverter not already charging
      - conditions:
          - condition: trigger
            id:
              - EV Power 0
          - condition: time
            after: "05:30:00"
            before: "23:30:00"
            weekday:
              - sun
              - sat
              - fri
              - wed
              - thu
              - tue
              - mon
          - condition: state
            entity_id: !input foxess_cloud_scheduler_enable
            state: "on"
        sequence:
          - alias: Set Scheduler
            action: foxess_cloud.set_schedule
            data:
              device_sn: !input foxess_cloud_inverter_serial
              groups:
                #Night time to midnight charging 
                - enable: 0
                  startHour: 23
                  startMinute: 30
                  endHour: 23
                  endMinute: 59
                  workMode: ForceCharge
                  minSocOnGrid: 20
                  fdSoc: 100
                  fdPwr: !input foxess_cloud_charge_rate
                  maxSoc: 100
                # Midnight to early morning
                - enable: 0
                  startHour: 0
                  startMinute: 0
                  endHour: 5
                  endMinute: 29
                  workMode: ForceCharge
                  minSocOnGrid: 20
                  fdSoc: 100
                  fdPwr: !input foxess_cloud_charge_rate
                  maxSoc: 100
                # (Daytime) Early morning to night time
                - enable: 0
                  startHour: 5
                  startMinute: 30
                  endHour: 23
                  endMinute: 29
                  workMode: ForceCharge
                  minSocOnGrid: 20
                  fdSoc: 100
                  fdPwr: !input foxess_cloud_charge_rate
                  maxSoc: 100
          - alias: Notification
            choose:
              - alias: Notify if enabled
                conditions:                
                  - condition: template
                    alias: Are Notifications Enabled? 
                    value_template: >- 
                      {{ notification_enabled }}
                sequence:
                  - service: !input notification_device
                    data:
                      title: Battery Stop Charging
                      message: "Stopped Battery Charging During Day"            
          - event: !input notification_event
            event_data:
              title: Battery Stop Charging
              message: "Stopped Battery Charging During Day"
        alias: Car Stops Charging, During Day, Stop Charging
      - conditions:
          - condition: trigger
            id:
              - Time 05:29:55
          - condition: numeric_state
            entity_id: !input zappi_ev_power
            below: 1
          - condition: state
            entity_id: !input foxess_cloud_scheduler_enable
            state: "on"
        sequence: 
          - alias: Set Scheduler
            action: foxess_cloud.set_schedule
            data:
              device_sn: !input foxess_cloud_inverter_serial
              groups:
                #Night time to midnight charging 
                - enable: 0
                  startHour: 23
                  startMinute: 30
                  endHour: 23
                  endMinute: 59
                  workMode: ForceCharge
                  minSocOnGrid: 20
                  fdSoc: 100
                  fdPwr: !input foxess_cloud_charge_rate
                  maxSoc: 100
                # Midnight to early morning
                - enable: 0
                  startHour: 0
                  startMinute: 0
                  endHour: 5
                  endMinute: 29
                  workMode: ForceCharge
                  minSocOnGrid: 20
                  fdSoc: 100
                  fdPwr: !input foxess_cloud_charge_rate
                  maxSoc: 100
                # (Daytime) Early morning to night time
                - enable: 0
                  startHour: 5
                  startMinute: 30
                  endHour: 23
                  endMinute: 29
                  workMode: ForceCharge
                  minSocOnGrid: 20
                  fdSoc: 100
                  fdPwr: !input foxess_cloud_charge_rate
                  maxSoc: 100
          - alias: Notification
            choose:
              - alias: Notify if enabled
                conditions:                
                  - condition: template
                    alias: Are Notifications Enabled? 
                    value_template: >- 
                      {{ notification_enabled }}
                sequence:
                  - service: !input notification_device
                    data:
                      title: Battery Stop Charging
                      message: "End of Night, Car Not Charging, Stopped Charging"         
          - event: !input notification_event
            event_data:
              title: Battery Stop Charging
              message: "End of Night, Car Not Charging, Stopped Charging"
        alias: When its end of night, car isnt charging, stop charge

  # End Stop Charging Actions

  # Error Charging Actions
  - alias: Battery Discharge Power Check (Notify)
    choose:
      # OPTION A: Cloud integration bad (separate branch)
      - alias: ERROR - FoxESS Cloud integration bad / sensors unavailable
        conditions:
          - condition: trigger
            id:
              - foxess_discharge_sensor_bad
              - foxess_work_mode_bad
              - foxess_scheduler_enable_bad
        sequence:
          - alias: Notification
            choose:
              - alias: Notify if enabled
                conditions:
                  - condition: template
                    alias: Are Notifications Enabled?
                    value_template: "{{ notification_enabled }}"
                sequence:
                  - service: !input notification_device
                    data:
                      title: "FoxESS Cloud Error"
                      message: "FoxESS Cloud integration looks unhealthy (sensor unavailable/unknown). Automations may not work correctly."
          - event: !input notification_event
            event_data:
              title: FoxESS Cloud Error
              message: "FoxESS Cloud integration looks unhealthy (sensor unavailable/unknown). Automations may not work correctly."

      # OPTION B: EV started charging -> delay -> check discharge (guard multiple sensors)
      - alias: CHECK - Battery discharging to EV
        conditions:
          - condition: trigger
            id:
              - foxess_cloud_battery_discharge_above_2
              - zappi_ev_charging_above_1
          - condition: numeric_state
            entity_id: !input zappi_ev_power
            above: 1
          - condition: numeric_state
            entity_id: !input foxess_cloud_battery_discharge_power
            above: 2000
        sequence:
          - alias: Notification
            choose:
              - alias: Notify if enabled
                conditions:
                  - condition: template
                    alias: Are Notifications Enabled?
                    value_template: "{{ notification_enabled }}"
                sequence:
                  - service: !input notification_device
                    data:
                      title: "Battery Discharging to EV"
                      message: "Battery discharge is above 2000W while the car is charging."
          - event: !input notification_event
            event_data:
              title: Battery Discharging to EV
              message: "Battery discharge is above 2000W while the car is charging."

mode: single
max_exceeded: silent